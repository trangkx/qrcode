<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thanh toán QR</title>
  <link rel="preconnect" href="https://img.vietqr.io">
  <style>
    /* ====== Theme (dark fintech) ====== */
    :root{
      --bg:#0b1220; --card:#111827; --muted:#9ca3af;
      --ink:#e5e7eb; --border:#374151; --brand:#059669;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:"Segoe UI",Roboto,Arial,sans-serif;background:#0f172a;color:var(--ink)}
    .wrap{max-width:980px;margin:28px auto;padding:16px}
    h1{font-size:22px;margin:0 0 16px}

    /* ====== Layout ====== */
    .grid{display:grid;grid-template-columns:420px 1fr;gap:18px}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }
    .card{background:var(--card);border-radius:14px;padding:20px;box-shadow:0 10px 24px rgba(0,0,0,.35)}
    .card.hide{display:none}
    /* khi chỉ còn QR, căn giữa cho đẹp */
    .only-qr{grid-template-columns:1fr}
    .qr-center{max-width:420px;margin:0 auto}

    /* ====== QR & info ====== */
    .qr{width:320px;height:320px;border:1px solid var(--border);border-radius:12px;display:flex;align-items:center;justify-content:center;overflow:hidden;margin:10px auto;background:#fff}
    .qr img{width:100%;height:100%;object-fit:contain}
    .info-line{margin-top:10px;font-size:15px}
    .info-line span{font-weight:700}
    .mono{font-variant-numeric: tabular-nums}

    /* ====== Controls ====== */
    .btns{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-top:12px}
    button{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#1f2937;cursor:pointer;font-weight:600;color:var(--ink)}
    .primary{background:var(--brand);border-color:var(--brand)}
    .ghost{background:#1f2937}
    .link{background:transparent;border:0;color:var(--muted);text-decoration:underline;cursor:pointer;padding:6px 8px}
    input[type=text]{padding:10px;border-radius:8px;border:1px solid var(--border);background:#0b1220;color:var(--ink);width:220px;text-align:right}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted);font-size:13px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Thanh toán QR để được gọi video với em Lê Thị Trang</h1>

  <div id="layout" class="grid">
    <!-- LEFT: QR panel -->
    <div id="panelQR" class="card qr-center">
      <div class="qr"><img id="qrimg" alt="QR sẽ hiển thị ở đây"></div>

      <div class="info-line">Ngân hàng: <span>OCB</span></div>
      <div class="info-line">Số TK: <span id="accText" class="mono">0030104444444444</span></div>
      <div class="info-line">Số tiền: <span id="amountShow" class="mono">—</span></div>
      <div class="info-line">Nội dung: <span id="addInfo" class="mono">—</span></div>

      <div class="btns">
        <button class="primary" id="copyAll">Copy thông tin</button>
        <button class="ghost" id="copyAmount">Copy số tiền</button>
        <button class="ghost" id="openQR">Mở ảnh QR</button>
        <button class="ghost" id="downloadQR">Tải ảnh QR</button>
      </div>

      <!-- Nút mở lại form -->
      <div class="btns" id="reopenWrap" style="display:none">
        <button class="link" id="reopenForm">Nhập lại số tiền</button>
      </div>
    </div>

    <!-- RIGHT: form panel -->
    <div id="panelForm" class="card">
      <h3>Nhập số tiền</h3>
      <div class="row">
        <input type="text" id="amount" placeholder="VD: 500.000">
        <button class="primary" id="makeQR">Tạo QR</button>
      </div>
      <p class="muted" style="margin-top:10px">Số tiền hiển thị và copy sẽ có dấu chấm (ví dụ: 20.000).</p>
    </div>
  </div>
</div>

<script>
  const BANK = 'ocb';
  const ACCOUNT = '0030104444444444';
  const state = { url:'', amount:0, addInfo:'' };

  // Helpers format
  const formatNumber = n => n.toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.');
  const parseNumber = s => Number((s||'').replace(/\./g,''));

  function genAddInfo(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    const rand = Math.floor(1000 + Math.random()*9000);
    return `HD${y}${m}${day}-${rand}`;
  }

  function makeQR(){
    const raw = document.getElementById('amount').value;
    const amount = parseNumber(raw);
    if(!amount || amount<=0){ alert('Nhập số tiền hợp lệ'); return; }

    const add = genAddInfo();
    const base = `https://img.vietqr.io/image/${BANK}-${ACCOUNT}-qr_only.png`;
    const url  = `${base}?addInfo=${encodeURIComponent(add)}&amount=${encodeURIComponent(amount)}`;

    // cập nhật UI
    document.getElementById('qrimg').src = url;
    document.getElementById('addInfo').textContent   = add;
    document.getElementById('amountShow').textContent = formatNumber(amount) + ' VND';
    document.getElementById('amount').value = formatNumber(amount);

    // lưu trạng thái
    state.url = url; state.amount = amount; state.addInfo = add;

    // Ẩn form, chỉ còn QR
    document.getElementById('panelForm').classList.add('hide');
    document.getElementById('reopenWrap').style.display = 'flex';
    const layout = document.getElementById('layout');
    layout.classList.add('only-qr');          // 1 cột, căn giữa
    document.getElementById('panelQR').classList.add('qr-center');
  }

  function reopenForm(){
    document.getElementById('panelForm').classList.remove('hide');
    document.getElementById('reopenWrap').style.display = 'none';
    const layout = document.getElementById('layout');
    layout.classList.remove('only-qr');
    document.getElementById('panelQR').classList.remove('qr-center');
    // focus số tiền
    setTimeout(()=>document.getElementById('amount').focus(), 50);
  }

  async function copyAll(){
    if(!state.url){ alert('Tạo QR trước đã'); return; }
    const t = `Ngân hàng: OCB\nSTK: ${ACCOUNT}\nSố tiền: ${formatNumber(state.amount)} VND\nNội dung: ${state.addInfo}`;
    try{ await navigator.clipboard.writeText(t); alert('Đã copy thông tin'); }
    catch{ alert('Không copy được'); }
  }
  async function copyAmount(){
    const v = state.amount || parseNumber(document.getElementById('amount').value);
    if(!v){ alert('Chưa nhập số tiền'); return; }
    try{ await navigator.clipboard.writeText(formatNumber(v)); alert('Đã copy số tiền'); }
    catch{ alert('Không copy được'); }
  }
  function openQR(){
    if(!state.url){ alert('Tạo QR trước đã'); return; }
    window.open(state.url,'_blank');
  }
  async function downloadQR(){
    if(!state.url){ alert('Tạo QR trước đã'); return; }
    try{
      const res = await fetch(state.url);
      const blob = await res.blob();
      const u = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = u; a.download = `vietqr_${BANK}_${ACCOUNT}_${state.amount}.png`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(u);
    }catch(e){ alert('Không tải được ảnh'); }
  }

  // Bind
  document.getElementById('makeQR').addEventListener('click', makeQR);
  document.getElementById('copyAll').addEventListener('click', copyAll);
  document.getElementById('copyAmount').addEventListener('click', copyAmount);
  document.getElementById('openQR').addEventListener('click', openQR);
  document.getElementById('downloadQR').addEventListener('click', downloadQR);
  document.getElementById('reopenForm').addEventListener('click', reopenForm);

  // Nhập tiền tự thêm dấu chấm
  document.getElementById('amount').addEventListener('input', (e)=>{
    let v = e.target.value.replace(/\D/g,'');
    e.target.value = v ? formatNumber(v) : '';
  });

  // hiển thị STK
  document.getElementById('accText').textContent = ACCOUNT;
</script>
</body>
</html>